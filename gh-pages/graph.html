<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.5/dist/loadingoverlay.min.js"></script>
  <title>Grafo De Deslocamento</title>
  <script src="js/echarts.js"></script>
  <script src=js/utils.js></script>
</head>

<body>
  <div class="row">
    <div class="col-md-12 "id="main" style="width: 500px;height:700px;"></div>
    <!-- <div class="col-md-4">
      <select id="segment-filter" onchange="dropSelect(this)">
        <option value="Teatro">Teatro</option>
        <option value="Circo">Circo</option>
        <option value="Orquestra">Orquestra</option>
        <option value="Museu">Museu</option>
      </select>
    </div> -->
  </div>


  <script type="text/javascript">
  // $("#main").LoadingOverlay("show", {
  //     background  : "rgba(255, 255, 255)"
  // });
    var _links = []

    var myChart = echarts.init(document.getElementById('main'));

    var option = {
      title: {
        text: "Grafo De Deslocamento",
        subtext: "Por Estado/Região",
        top: "top",
        left: "left"
      },
      tooltip: {},
      legend: [{
        formatter: function(name) {
          return echarts.format.truncateText(name, 40, '14px Arial', '…');
        },
        tooltip: {
          show: true
        },
        selectedMode: 'false',
        bottom: 1,
        data: ['Norte', 'Nordeste', 'Sudeste', 'Sul', 'Centro-Oeste']
      }],

      // toolbox: {
      //   show: false,
      //   feature: {
      //     dataView: {
      //       show: false,
      //       readOnly: true
      //     },
      //     restore: {
      //       show: false
      //     },
      //     saveAsImage: {
      //       show: false
      //     }
      //   }
      // },
      // animation: false,
      // animationDuration: 1000000,
      // animationEasingUpdate: 'linear',
      series: [{
        name: 'Deslocamentos Internos',
        type: 'graph',
        layout: 'none',
        force: {
          repulsion: 40000,
          // gravity: 0.05,
          layoutAnimation: true
        },
        symbol: "circle",
        data: chartData,
        links: _links,
        categories: categories,
        focusNodeAdjacency: true,
        roam: true,
        label: {
          normal: {
            color: '#ffffff',
            show: true,
            position: 'inside',
            fontWeight: 'bold'
          }
        },
        lineStyle: {
          color: "#bbbbbb",
          type: "solid",
          label: {
              show: false,
          },
          // curveness: 0.2,
        }
      }]
    };

    getLinks()

    myChart.setOption(option);

    var internalDisplacement = []
    var counter = {}
    var sourceList = []
    var counterLinks = {}

    var result = ""
    var inverse = ""

    function linkRange(width) {
      if (width >= 0 && width <= 50) {
        width = 1
      } else if (width >= 51 && width <= 150) {
        width = 2
      } else if (width >= 151 && width <= 600) {
        width = 4
      } else if (width >= 601 && width <= 1500) {
        width = 6
      } else {
        width = 8
      }

      return width
    }

    function symbolRange(symbolSize) {
      if (symbolSize >= 0 && symbolSize <= 50) {
        symbolSize = 25
      } else if (symbolSize >= 51 && symbolSize <= 150) {
        symbolSize = 50
      } else if (symbolSize >= 151 && symbolSize <= 600) {
        symbolSize = 75
      } else if (symbolSize >= 601 && symbolSize <= 1500) {
        symbolSize = 90
      } else {
        symbolSize = 120
      }

      return symbolSize
    }

    function retorna(data){
      let deslocamentos = data.data.deslocamentos

      deslocamentos.forEach(function(element) {
        if (element.UFOrigem == element.UFDestino) {
          internalDisplacement.push(element.UFOrigem)
          return;
        }

        result = element["UFOrigem"] + " - " + element["UFDestino"];
        inverse = element["UFDestino"] + " - " + element["UFOrigem"];

        if (counterLinks[result] !== undefined) {
          counterLinks[result] += 1;
        }
        else {
          if (counterLinks[inverse] !== undefined) {
            counterLinks[inverse] += 1;
          } else {
            counterLinks[result] = 1;
          }
        }

      })

      linksNames = Object.keys(counterLinks)

      linksNames.forEach(function(element) {

        _links.push({
          source: ufDict[element.substr(0, element.indexOf(' -'))],
          target: ufDict[element.substring(element.indexOf("- ") + 2)],
          lineStyle: {
            width: linkRange(counterLinks[element]),
            opacity: 1,
            curveness: 0.3,
          }
        })
      })


      counter = _.countBy(internalDisplacement)
      // console.log(counter)

      chartData.forEach(function(element) {
        element.value = counter[element.name]
        element.symbolSize = symbolRange(counter[element.name])
        element.name = ufDict[element.name]
        element.x = Math.floor(Math.random() * Math.floor(15)),
        element.y = Math.floor(Math.random() * Math.floor(15))
      })
      console.log(_links)
      console.log(chartData)

      myChart.setOption(option)
      console.log(option)
    }

    function getLinks() {

      $.ajax({
        url: "https://salic.dev.lappis.rocks/graphiql?query=%7B%0A%20%20deslocamentos%20%7B%0A%20%20%20%20UFOrigem%0A%20%20%20%20UFDestino%0A%20%20%7D%0A%20%20%0A%7D",
        type: "GET",
        success: function(data) {
          retorna(data)
          // setTimeout(function(){$("#main").LoadingOverlay("hide");}, 15000);

        },

        error: function(error) {
          alert("Falha na conexão. Reinicie a página");
          console.log(error)
        }
      });
    }

  </script>
</body>

</html>
